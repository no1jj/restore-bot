name: Discord Notification

on:
  push:
    branches: ["*"]
    tags: ["v*"]
    paths:
      - 'src/**'
      - 'docs/**'
  pull_request:
    types: [opened, closed, labeled, unlabeled]
    paths:
      - 'src/**'
      - 'docs/**'
  release:
    types: [published]
  issues:
    types: [opened, closed]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 9 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ í•œêµ­ì‹œê°„ 09:00

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get context
        id: context
        run: |
          echo "Event=${{ github.event_name }}"    >> $GITHUB_OUTPUT
          echo "Ref=${{ github.ref }}"             >> $GITHUB_OUTPUT
          echo "Repo=${{ github.repository }}"     >> $GITHUB_OUTPUT
          echo "Actor=${{ github.actor }}"         >> $GITHUB_OUTPUT
          echo "Sha=${{ github.sha }}"             >> $GITHUB_OUTPUT
          echo "Action=${{ github.event.action }}" >> $GITHUB_OUTPUT
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Timestamp=$TIMESTAMP"              >> $GITHUB_OUTPUT

      - name: Get commit info (push only)
        id: commit
        if: ${{ github.event_name == 'push' }}
        run: |
          MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Msg=$MSG"                          >> $GITHUB_OUTPUT
          echo "CommitAuthor=$AUTHOR"              >> $GITHUB_OUTPUT
          echo "Url=https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT
          FILES=$(git diff --name-only HEAD~1 | wc -l)
          DIFF=$(git diff --shortstat HEAD~1 || echo "0 files changed")
          INS=$(echo "$DIFF" | grep -o '[0-9]\+ insertion' | cut -d' ' -f1 || echo "0")
          DEL=$(echo "$DIFF" | grep -o '[0-9]\+ deletion' | cut -d' ' -f1 || echo "0")
          echo "Files=$FILES"                      >> $GITHUB_OUTPUT
          echo "Insertions=$INS"                   >> $GITHUB_OUTPUT
          echo "Deletions=$DEL"                    >> $GITHUB_OUTPUT

      - name: Get language stats (push only)
        id: lang
        if: ${{ github.event_name == 'push' }}
        run: |
          LANG_JSON=$(curl -s https://api.github.com/repos/${{ github.repository }}/languages)
          TOTAL=$(echo $LANG_JSON | jq 'add')
          if [ "$TOTAL" != "null" ] && [ "$TOTAL" -gt 0 ]; then
            STATS=$(echo $LANG_JSON | jq -r --arg total "$TOTAL" 'to_entries | map("\(.key): \((.value / ($total|tonumber) * 100) | round)%" ) | join(", ")')
            echo "LangStats=$STATS" >> $GITHUB_OUTPUT
          else
            echo "LangStats=No language data available" >> $GITHUB_OUTPUT
          fi

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          ALLOWED_MENTIONS: '{"parse":["roles","users"]}'
        run: |
          EVENT="${{ steps.context.outputs.Event }}"
          ACTOR="${{ steps.context.outputs.Actor }}"
          REPO="${{ steps.context.outputs.Repo }}"
          REF="${{ steps.context.outputs.Ref }}"
          ACTION="${{ steps.context.outputs.Action }}"
          TS="${{ steps.context.outputs.Timestamp }}"

          generate_payload() {
            jq -n \
              --argjson allowed "$ALLOWED_MENTIONS" \
              --arg title "$1" \
              --arg desc "$2" \
              --arg timestamp "$TS" \
              --argjson color "$3" \
              --arg thread "$4" '{
                embeds: [{
                  title: $title,
                  description: $desc,
                  color: $color,
                  timestamp: $timestamp
                }],
                allowed_mentions: $allowed,
                thread_name: $thread,
                thread_auto_archive_duration: 1440
              }' > payload.json
          }

          if [ "$EVENT" == "push" ]; then
            MSG="${{ steps.commit.outputs.Msg }}"
            AUTHOR="${{ steps.commit.outputs.CommitAuthor }}"
            URL="${{ steps.commit.outputs.Url }}"
            FILES="${{ steps.commit.outputs.Files }}"
            INS="${{ steps.commit.outputs.Insertions }}"
            DEL="${{ steps.commit.outputs.Deletions }}"
            LANGS="${{ steps.lang.outputs.LangStats }}"

            if [[ "$REF" == refs/tags/* ]]; then
              TAG="${REF#refs/tags/}"
              DESC=$'**'"$AUTHOR"'** released tag `'"$TAG"'`.\n[ğŸ”— View Release](https://github.com/'"$REPO"'/releases/tag/'"$TAG"')\n\nì–¸ì–´ í†µê³„: '"$LANGS"
              COLOR=16753920
              THREAD="release-$TAG"
            else
              DESC=$'**'"$AUTHOR"'**ê°€ **'"$REPO"'**ì— ì»¤ë°‹í–ˆìŠµë‹ˆë‹¤:\n['"$MSG"']('"$URL"')\nFiles: '"$FILES"', +'"$INS"'/-'"$DEL"' lines\n\nì–¸ì–´ í†µê³„: '"$LANGS"
              COLOR=5814783
              THREAD="push-${GITHUB_SHA:0:7}"
            fi

            generate_payload "ğŸ“¦ Push Event" "$DESC" $COLOR "$THREAD"

          elif [ "$EVENT" == "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            PR_AUTHOR="${{ github.event.pull_request.user.login }}"
            
            if [ "$ACTION" == "opened" ]; then
              DESC=$'**'"$PR_AUTHOR"'**ê°€ ìƒˆ PRì„ ì—´ì—ˆìŠµë‹ˆë‹¤:\n[#'"$PR_NUM"': '"$PR_TITLE"']('"$PR_URL"')'
              COLOR=5793266
            elif [ "$ACTION" == "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
                DESC=$'**'"$PR_AUTHOR"'**ì˜ PRì´ ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤:\n[#'"$PR_NUM"': '"$PR_TITLE"']('"$PR_URL"')'
                COLOR=10181046
              else
                DESC=$'**'"$PR_AUTHOR"'**ì˜ PRì´ ë‹«í˜”ìŠµë‹ˆë‹¤:\n[#'"$PR_NUM"': '"$PR_TITLE"']('"$PR_URL"')'
                COLOR=15158332
              fi
            elif [ "$ACTION" == "labeled" ] || [ "$ACTION" == "unlabeled" ]; then
              LABEL="${{ github.event.label.name }}"
              DESC=$'**'"$PR_AUTHOR"'**ì˜ PR #'"$PR_NUM"'ì— ë¼ë²¨ ë³€ê²½: `'"$LABEL"'` '"$ACTION"'\n['"$PR_TITLE"']('"$PR_URL"')'
              COLOR=3447003
            else
              exit 0
            fi
            
            THREAD="pr-$PR_NUM"
            generate_payload "ğŸ”€ Pull Request" "$DESC" $COLOR "$THREAD"

          elif [ "$EVENT" == "release" ]; then
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            RELEASE_NAME="${{ github.event.release.name }}"
            RELEASE_URL="${{ github.event.release.html_url }}"
            RELEASE_AUTHOR="${{ github.event.release.author.login }}"
            RELEASE_BODY="${{ github.event.release.body }}"
            
            DESC=$'**'"$RELEASE_AUTHOR"'**ê°€ ìƒˆ ë¦´ë¦¬ìŠ¤ë¥¼ ë°œí–‰í–ˆìŠµë‹ˆë‹¤:\n['"$RELEASE_NAME"' ('"$RELEASE_TAG"')]('"$RELEASE_URL"')'
            COLOR=16750848
            THREAD="release-$RELEASE_TAG"
            
            generate_payload "ğŸš€ New Release" "$DESC" $COLOR "$THREAD"

          elif [ "$EVENT" == "issues" ]; then
            ISSUE_NUM="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            ISSUE_URL="${{ github.event.issue.html_url }}"
            ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
            
            if [ "$ACTION" == "opened" ]; then
              DESC=$'**'"$ISSUE_AUTHOR"'**ê°€ ìƒˆ ì´ìŠˆë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤:\n[#'"$ISSUE_NUM"': '"$ISSUE_TITLE"']('"$ISSUE_URL"')'
              COLOR=15844367
            elif [ "$ACTION" == "closed" ]; then
              DESC=$'**'"$ACTOR"'**ê°€ ì´ìŠˆë¥¼ ë‹«ì•˜ìŠµë‹ˆë‹¤:\n[#'"$ISSUE_NUM"': '"$ISSUE_TITLE"']('"$ISSUE_URL"')'
              COLOR=5763719
            else
              exit 0
            fi
            
            THREAD="issue-$ISSUE_NUM"
            generate_payload "ğŸ› Issue" "$DESC" $COLOR "$THREAD"

          elif [ "$EVENT" == "issue_comment" ]; then
            COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
            COMMENT_URL="${{ github.event.comment.html_url }}"
            ISSUE_NUM="${{ github.event.issue.number }}"
            ISSUE_TITLE="${{ github.event.issue.title }}"
            
            if [[ "${{ github.event.issue.pull_request }}" != "" ]]; then
              DESC=$'**'"$COMMENT_AUTHOR"'**ê°€ PRì— ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤:\n[#'"$ISSUE_NUM"': '"$ISSUE_TITLE"']('"$COMMENT_URL"')'
              COLOR=3447003
              THREAD="pr-$ISSUE_NUM"
            else
              DESC=$'**'"$COMMENT_AUTHOR"'**ê°€ ì´ìŠˆì— ëŒ“ê¸€ì„ ë‚¨ê²¼ìŠµë‹ˆë‹¤:\n[#'"$ISSUE_NUM"': '"$ISSUE_TITLE"']('"$COMMENT_URL"')'
              COLOR=10027213
              THREAD="issue-$ISSUE_NUM"
            fi
            
            generate_payload "ğŸ’¬ New Comment" "$DESC" $COLOR "$THREAD"

          elif [ "$EVENT" == "schedule" ]; then
            DESC=$'ì •ê¸° ì•Œë¦¼: ì´ë²ˆ ì£¼ ê°œë°œ ê³„íšì„ ê²€í† í•˜ì„¸ìš”!\n[ì €ì¥ì†Œ ë§í¬](https://github.com/'"$REPO"')'
            COLOR=7506394
            THREAD="weekly-reminder-$(date +%Y%m%d)"
            
            generate_payload "ğŸ“… Weekly Reminder" "$DESC" $COLOR "$THREAD"
          else
            exit 0
          fi

          # Discordë¡œ ë©”ì‹œì§€ ì „ì†¡ ì‹œë„, ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„
          curl -s -f -X POST -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK" || {
            echo "ì²« ë²ˆì§¸ ì‹œë„ ì‹¤íŒ¨. 5ì´ˆ í›„ ì¬ì‹œë„í•©ë‹ˆë‹¤..."
            sleep 5
            curl -s -f -X POST -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK" || {
              echo "ë‘ ë²ˆì§¸ ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Discord webhook URLì„ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            }
          }
          
          echo "Discord ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."
