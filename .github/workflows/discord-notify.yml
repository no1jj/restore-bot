name: Discord Notification

on:
  push:
    branches: ["*"]
    tags: ["v*"]
  pull_request:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get context
        id: context
        run: |
          echo "event=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Get commit info (push only)
        id: commit
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "msg=$(git log -1 --pretty=format:'%s')" >> $GITHUB_OUTPUT
          echo "url=https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Send Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          EVENT="${{ steps.context.outputs.event }}"
          ACTOR="${{ steps.context.outputs.actor }}"
          REPO="${{ steps.context.outputs.repo }}"
          REF="${{ steps.context.outputs.ref }}"
          TIMESTAMP=$(date --utc +%Y-%m-%dT%H:%M:%SZ)

          generate_payload() {
            jq -n --arg title "$1" --arg desc "$2" --arg timestamp "$TIMESTAMP" --argjson color "$3" '{
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                timestamp: $timestamp
              }]
            }' > payload.json
          }

          if [ "$EVENT" == "push" ]; then
            MSG="${{ steps.commit.outputs.msg }}"
            URL="${{ steps.commit.outputs.url }}"

            if [[ "$REF" == refs/tags/* ]]; then
              TAG="${REF#refs/tags/}"
              generate_payload "🚀 배포 태그 푸시됨: $TAG" "**$ACTOR**가 \`$TAG\` 태그를 푸시했습니다.\n[🔗 태그 보기](https://github.com/$REPO/releases/tag/$TAG)" 16753920
            else
              generate_payload "📦 Push 이벤트 발생" "**$ACTOR**가 **$REPO**에 커밋:\n[$MSG]($URL)" 5814783
            fi

          elif [ "$EVENT" == "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            MERGED="${{ github.event.pull_request.merged }}"

            if [ "$ACTION" == "opened" ]; then
              generate_payload "📝 새 Pull Request" "**$ACTOR**가 PR 생성: [$PR_TITLE]($PR_URL)" 3447003
            elif [ "$ACTION" == "closed" ] && [ "$MERGED" == "true" ]; then
              generate_payload "✅ Pull Request 머지됨" "**$ACTOR**가 PR을 머지함: [$PR_TITLE]($PR_URL)" 5763719
            else
              echo "PR closed but not merged. No message sent."
              exit 0
            fi

          else
            echo "지원하지 않는 이벤트: $EVENT"
            exit 0
          fi

          curl -X POST -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK"
